---
phase: 01-test-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Makefile
  - scripts/test-stability.sh
autonomous: true

must_haves:
  truths:
    - "Running `make test` executes all tests with race detection enabled"
    - "A stability script can run tests 100 times to detect flaky tests"
    - "The stability script fails fast on first flaky test detection"
    - "Race detection overhead is acceptable (tests complete within reasonable time)"
  artifacts:
    - path: "Makefile"
      provides: "Race-enabled test target"
      contains: "-race"
    - path: "scripts/test-stability.sh"
      provides: "100-run stability test script"
      contains: "for i in {1..100}"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "Makefile"
      via: "CI runs make test"
      pattern: "make test"
    - from: "scripts/test-stability.sh"
      to: "go test"
      via: "bash loop invoking go test"
      pattern: "go test.*-race"
---

<objective>
Enable race detection for all tests and create flaky test detection script

Purpose: Establish race detection as mandatory for all packages (INFRA-01) and create tooling to detect flaky tests (QUAL-02). Currently only `make test_miner` uses `-race` flag. This plan makes race detection the default and provides a script to run tests 100 times for stability validation.

Output: Updated Makefile with race-enabled tests and a new `scripts/test-stability.sh` script.
</objective>

<execution_context>
@/home/overlordyorch/.claude/get-shit-done/workflows/execute-plan.md
@/home/overlordyorch/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-foundation/01-CONTEXT.md
@.planning/phases/01-test-foundation/01-RESEARCH.md
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Makefile for race detection</name>
  <files>Makefile</files>
  <action>
Modify the Makefile to enable race detection for the main `test` target:

1. Update the `test` target to include `-race` flag for all test runs
2. Keep the special handling for cache package (sequential execution with -p 1 -parallel 1)
3. Add a new `test-no-race` target for quick local testing when race detection overhead is not needed
4. Keep `test_miner` as-is (it already has -race)

The modified test target should look like:
```makefile
test: ## Run tests with race detection (PKG=package_name for specific package, VERBOSE=1 for verbose output)
	@echo "Running tests with race detection..."
	@if [ -n "$(PKG)" ]; then \
		if [ "$(PKG)" = "cache" ]; then \
			echo "Running cache tests sequentially (143 tests with shared miniredis)..."; \
			go test -race $(if $(VERBOSE),-v) -tags test -p 1 -parallel 1 ./$(PKG)/...; \
		else \
			go test -race $(if $(VERBOSE),-v) -tags test -p 4 -parallel 4 ./$(PKG)/...; \
		fi; \
	else \
		go test -race $(if $(VERBOSE),-v) -tags test -p 4 -parallel 4 ./...; \
	fi

test-no-race: ## Run tests without race detection (faster, for quick local iterations)
	@echo "Running tests without race detection..."
	@go test $(if $(VERBOSE),-v) -tags test -p 4 -parallel 4 ./...
```

Note: Adding -race will increase test execution time by 2-20x (per Go documentation). This is acceptable per user decision in 01-CONTEXT.md: "Race detection runs on every PR".
  </action>
  <verify>
1. `make test` output shows "Running tests with race detection..."
2. Tests complete (may take longer due to race detection overhead)
3. `make test-no-race` provides a quick alternative for local dev
  </verify>
  <done>
Makefile `test` target includes `-race` flag. New `test-no-race` target exists for quick local testing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create stability test script</name>
  <files>scripts/test-stability.sh</files>
  <action>
Create `scripts/test-stability.sh` for 100-run flaky test detection:

```bash
#!/bin/bash
# test-stability.sh - Run test suite 100 times to detect flaky tests
# Usage: ./scripts/test-stability.sh [package]
# Example: ./scripts/test-stability.sh miner
#
# Per CLAUDE.md Rule #1: No flaky tests, no race conditions, no mock/fake tests
# Any test that fails once in 100 runs must be fixed or skipped with TODO comment.
#
# This script is used by:
# 1. Nightly CI stability checks
# 2. Manual validation before claiming tests are stable
#
# Exit codes:
#   0 - All 100 runs passed
#   1 - At least one run failed (flaky test detected)

set -euo pipefail

RUNS=${RUNS:-100}
PACKAGE=${1:-"./..."}

echo "=============================================="
echo "Flaky Test Detection - $RUNS runs"
echo "=============================================="
echo "Package: $PACKAGE"
echo "Race detection: enabled"
echo "Shuffle: enabled"
echo ""
echo "Per CLAUDE.md Rule #1: Any failure = flaky = must fix"
echo ""

FAILURES=0
for i in $(seq 1 $RUNS); do
    printf "Run %3d/$RUNS... " "$i"

    # Run with -race and -shuffle to maximize variance
    # -count=1 disables test caching
    if go test -race -shuffle=on -count=1 -tags test -p 4 -parallel 4 "$PACKAGE" &>/dev/null; then
        echo "PASS"
    else
        echo "FAIL"
        ((FAILURES++))

        echo ""
        echo "=============================================="
        echo "FLAKY TEST DETECTED on run $i"
        echo "=============================================="
        echo "Rerunning with verbose output to capture failure:"
        echo ""

        # Rerun to capture output
        go test -race -shuffle=on -count=1 -tags test -v "$PACKAGE" || true

        echo ""
        echo "=============================================="
        echo "Action required:"
        echo "1. Identify the failing test from output above"
        echo "2. Either fix the flakiness or skip with:"
        echo "   t.Skip(\"TODO(phase3): fix flaky test - <reason>\")"
        echo "=============================================="
        exit 1
    fi
done

echo ""
echo "=============================================="
if [ $FAILURES -eq 0 ]; then
    echo "SUCCESS: All $RUNS runs passed"
    echo "Test suite is stable (no flaky tests detected)"
else
    echo "FAILED: $FAILURES/$RUNS runs failed"
    echo "Flaky tests detected - see output above"
    exit 1
fi
echo "=============================================="
```

Make the script executable with `chmod +x scripts/test-stability.sh`.
  </action>
  <verify>
1. File exists at `scripts/test-stability.sh`
2. Script is executable: `ls -la scripts/test-stability.sh` shows execute permission
3. Script runs without syntax errors: `bash -n scripts/test-stability.sh` returns 0
4. Running `./scripts/test-stability.sh miner` with RUNS=3 completes (quick validation)
  </verify>
  <done>
Stability script exists, is executable, and runs without syntax errors. Script accepts optional package argument and configurable RUNS environment variable.
  </done>
</task>

</tasks>

<verification>
1. `make test` runs all tests with `-race` flag enabled
2. `make test-no-race` runs tests without race detection (for quick local iteration)
3. `scripts/test-stability.sh` exists and is executable
4. Stability script fails fast on first flaky test detection
5. Stability script supports package argument and RUNS environment variable
</verification>

<success_criteria>
- Makefile updated with race-enabled `test` target
- New `test-no-race` target available for quick local testing
- `scripts/test-stability.sh` created and executable
- Running `RUNS=3 ./scripts/test-stability.sh miner` completes successfully (quick validation)
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-foundation/01-02-SUMMARY.md`
</output>
